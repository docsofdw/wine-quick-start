---
import { Image } from 'astro:assets';
import BaseLayout from './BaseLayout.astro';
import ImagePlaceholder from '../components/ui/ImagePlaceholder.astro';
import Breadcrumbs from '../components/ui/Breadcrumbs.astro';
import TableOfContents from '../components/ui/TableOfContents.astro';
import ConsultationCTA from '../components/ui/ConsultationCTA.astro';
import RelatedArticles from '../components/sections/RelatedArticles.astro';

interface RelatedArticle {
  title: string;
  slug: string;
  description?: string;
  category?: string;
  imagePrompt?: string;
  basePath?: string;
}

interface Props {
  title: string;
  description: string;
  author?: string;
  readTime?: string;
  category?: string;
  categorySlug?: string;
  schema?: object;
  featuredImage?: ImageMetadata;
  featuredImagePrompt?: string;
  relatedArticles?: RelatedArticle[];
}

const {
  title,
  description,
  author = 'Wine Quick Start Team',
  readTime = '5 min',
  category = 'Wine Guide',
  categorySlug = 'wine-pairings',
  schema,
  featuredImage,
  featuredImagePrompt,
  relatedArticles = []
} = Astro.props;

// Build breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: category, href: `/${categorySlug}/` },
  { label: title }
];
---

<BaseLayout {title} {description} {schema}>
  <article class="py-8 md:py-12 lg:py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
      <!-- Breadcrumbs -->
      <Breadcrumbs items={breadcrumbItems} />

      <!-- Article Header -->
      <header class="mb-10 md:mb-12">
        <div class="flex items-center gap-3 mb-4">
          <span class="inline-block px-3 py-1 bg-wine-50 text-wine-700 rounded-full text-sm font-medium">
            {category}
          </span>
          <span class="text-gray-400 text-sm">{readTime} read</span>
        </div>
        <h1 class="font-serif text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 leading-tight mb-4">
          {title}
        </h1>
        <p class="text-lg md:text-xl text-gray-600 leading-relaxed">
          {description}
        </p>
      </header>

      <!-- Featured Image -->
      {featuredImage ? (
        <div class="mb-10 -mx-4 sm:mx-0 sm:rounded-2xl overflow-hidden">
          <Image
            src={featuredImage}
            alt={title}
            class="w-full h-auto object-cover"
            widths={[400, 800, 1200]}
            sizes="(max-width: 640px) 100vw, (max-width: 1024px) 800px, 1200px"
          />
        </div>
      ) : featuredImagePrompt && (
        <div class="mb-10 -mx-4 sm:mx-0 sm:rounded-2xl overflow-hidden">
          <ImagePlaceholder
            prompt={featuredImagePrompt}
            aspectRatio="16:9"
            alt={title}
            class="w-full !rounded-none sm:!rounded-2xl"
          />
        </div>
      )}

      <!-- Two Column Layout: Content + TOC on Desktop -->
      <div class="lg:grid lg:grid-cols-[1fr_220px] lg:gap-10">
        <div>
          <!-- Quick Answer Slot -->
          <div class="mb-8 p-5 bg-gradient-to-r from-wine-50 to-gray-50 rounded-xl border-l-4 border-wine-500">
            <slot name="quick-answer" />
          </div>

          <!-- Article Content -->
          <div class="article-content">
            <slot />
          </div>
        </div>

        <!-- Sticky Table of Contents (Desktop Only) -->
        <aside class="hidden lg:block">
          <div class="sticky top-24">
            <TableOfContents />
            <ConsultationCTA />
          </div>
        </aside>
      </div>

      <!-- Related Articles -->
      {relatedArticles.length > 0 && (
        <RelatedArticles articles={relatedArticles} />
      )}
    </div>
  </article>
</BaseLayout>

<style>
  /* Article Content Styles - Clean & Minimal */
  .article-content {
    @apply text-gray-700 leading-relaxed;
  }

  /* Headings */
  .article-content :global(h2) {
    @apply text-2xl md:text-3xl font-bold text-gray-900 mt-12 mb-6 pb-2 border-b border-gray-100;
  }

  .article-content :global(h3) {
    @apply text-xl md:text-2xl font-semibold text-gray-900 mt-8 mb-4;
  }

  /* Paragraphs */
  .article-content :global(p) {
    @apply text-base md:text-lg mb-5 leading-relaxed;
  }

  /* Lists */
  .article-content :global(ul),
  .article-content :global(ol) {
    @apply mb-6 pl-5 space-y-2;
  }

  .article-content :global(li) {
    @apply text-base md:text-lg leading-relaxed;
  }

  .article-content :global(ul li) {
    @apply list-disc;
  }

  .article-content :global(ol li) {
    @apply list-decimal;
  }

  /* Links */
  .article-content :global(a) {
    @apply text-wine-600 underline underline-offset-2 decoration-wine-200 hover:decoration-wine-500 transition-colors;
  }

  /* Internal Links - subtle highlight */
  .article-content :global(a.internal-link) {
    @apply text-wine-700 font-medium no-underline border-b border-wine-200 hover:border-wine-500 hover:text-wine-800;
  }

  /* Strong text */
  .article-content :global(strong) {
    @apply font-semibold text-gray-900;
  }

  /* Author Attribution Box */
  .article-content :global(.bg-gray-50.rounded-lg.flex) {
    border: 1px solid #f3f4f6;
  }

  /* Wine Stats Box */
  .article-content :global(.bg-wine-50.rounded-lg) {
    border: 1px solid #fce8eb;
  }

  /* Regional Spotlight */
  .article-content :global(.bg-wine-50.border-wine-200) {
    @apply shadow-sm;
  }

  /* Related Articles Grid */
  .article-content :global(.grid.md\:grid-cols-2.gap-4 a) {
    text-decoration: none;
    border: 1px solid #f3f4f6;
  }

  .article-content :global(.grid.md\:grid-cols-2.gap-4 a:hover) {
    border-color: #f9d0d9;
  }

  /* Author Bio Footer */
  .article-content :global(.mt-12.p-6.bg-gray-50.rounded-lg.border) {
    @apply shadow-sm;
  }

  /* Tables */
  .article-content :global(table) {
    @apply w-full mb-6 text-sm;
  }

  .article-content :global(th) {
    @apply text-left font-semibold text-gray-900 p-3 bg-gray-50;
    border-bottom: 1px solid #e5e7eb;
  }

  .article-content :global(td) {
    @apply p-3;
    border-bottom: 1px solid #f3f4f6;
  }

  /* First element margin reset */
  .article-content :global(> *:first-child) {
    @apply mt-0;
  }

  /* Mobile optimizations */
  @media (max-width: 640px) {
    .article-content :global(h2) {
      @apply text-xl mt-8 mb-4;
    }

    .article-content :global(h3) {
      @apply text-lg mt-6 mb-3;
    }

    .article-content :global(p),
    .article-content :global(li) {
      @apply text-base;
    }
  }
</style>

<script>
  // Process markdown-style bold text
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.querySelector('.article-content');
    if (!content) return;

    // Convert **text** to <strong>text</strong>
    content.querySelectorAll('p, li').forEach(el => {
      if (el.innerHTML.includes('**')) {
        el.innerHTML = el.innerHTML.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      }
    });
  });
</script>
